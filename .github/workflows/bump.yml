name: Auto Version Bump

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'LICENSE'
      - '.github/workflows/ci.yml'

permissions:
  contents: write

jobs:
  bump:
    runs-on: ubuntu-latest
    if: |
      github.repository == 'enzomar/archipilot' &&
      !startsWith(github.event.head_commit.message, 'release:') &&
      !startsWith(github.event.head_commit.message, 'chore(release)')
    outputs:
      bumped: ${{ steps.bump.outputs.bumped }}
      new_version: ${{ steps.bump.outputs.new_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Use Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Typecheck
        run: npm run typecheck

      - name: Run tests
        run: npm test

      - name: Determine bump type from commits
        id: bump_type
        run: |
          # Collect commit messages since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log --pretty=format:"%s" "${LAST_TAG}..HEAD")
          fi

          echo "Commits since last tag:"
          echo "$COMMITS"

          # Determine bump type from conventional commit prefixes
          # BREAKING CHANGE or feat!: → major
          # feat: → minor
          # fix:, perf:, refactor:, etc. → patch
          BUMP="none"

          if echo "$COMMITS" | grep -qiE '(BREAKING CHANGE|^[a-z]+(\(.+\))?!:)'; then
            BUMP="major"
          elif echo "$COMMITS" | grep -qiE '^feat(\(.+\))?:'; then
            BUMP="minor"
          elif echo "$COMMITS" | grep -qiE '^(fix|perf|refactor|build|style|docs|chore|ci|test)(\(.+\))?:'; then
            BUMP="patch"
          fi

          echo "bump=$BUMP" >> "$GITHUB_OUTPUT"
          echo "Determined bump: $BUMP"

      - name: Bump version
        id: bump
        if: steps.bump_type.outputs.bump != 'none'
        run: |
          BUMP="${{ steps.bump_type.outputs.bump }}"
          echo "Bumping version: $BUMP"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # npm version creates commit + tag
          NEW_VERSION=$(npm version "$BUMP" -m "release: v%s" --no-git-tag-version)

          # Update CHANGELOG with new version header
          DATE=$(date +%Y-%m-%d)
          VERSION_NUM="${NEW_VERSION#v}"
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            sed -i "s/## \[Unreleased\]/## [${VERSION_NUM}] - ${DATE}/" CHANGELOG.md
          fi

          # Commit, tag, and push
          git add package.json CHANGELOG.md
          git commit -m "release: v${VERSION_NUM}"
          git tag "v${VERSION_NUM}"
          git push origin main --tags

          echo "bumped=true" >> "$GITHUB_OUTPUT"
          echo "new_version=${VERSION_NUM}" >> "$GITHUB_OUTPUT"
          echo "Released v${VERSION_NUM}"

      - name: Skip — no bump needed
        if: steps.bump_type.outputs.bump == 'none'
        run: |
          echo "No conventional commit prefix found — skipping version bump."
          echo "Use commit prefixes to trigger auto-bump:"
          echo "  feat: ...   → minor bump"
          echo "  fix: ...    → patch bump"
          echo "  feat!: ...  → major bump"
